<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">jbd_vis/client/stores/seq_diag_store.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/beinan/jbd_vis.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/seq_diagram/actor.jsx~Actor.html">Actor</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/actions/admin_action.js~AdminAction.html">AdminAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/admin/admin_components.jsx~AdminJobsBox.html">AdminJobsBox</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/admin/admin_monitor_view.jsx~AdminMonitorView.html">AdminMonitorView</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/admin/admin_question_view.jsx~AdminQuestionView.html">AdminQuestionView</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/actions/app_action.js~AppAction.html">AppAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/assignment_view.jsx~AssignmentView.html">AssignmentView</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/actions/assignments_action.js~AssignmentsAction.html">AssignmentsAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/actions/common_store_action.js~CommonStoreAction.html">CommonStoreAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/common_components.jsx~ContentBox.html">ContentBox</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/common_components.jsx~ContentSection.html">ContentSection</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/content_wrapper.jsx~ContentWrapper.html">ContentWrapper</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/replay_controls/control_side_bar.jsx~ControlSideBar.html">ControlSideBar</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/frame.jsx~Frame.html">Frame</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/common_components.jsx~ImmutablePropComponent.html">ImmutablePropComponent</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/actions/jvm_action.js~JVMAction.html">JVMAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/stores/job_store.js~JobStore.html">JobStore</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/replay_controls/jvm_list_drowdown.jsx~JvmListDrowDown.html">JvmListDrowDown</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/stores/jvm_store.js~JvmStore.html">JvmStore</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/views/jvms_view.jsx~JvmsView.html">JvmsView</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/seq_diagram/lifeline.jsx~Lifeline.html">Lifeline</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/main_side_bar.jsx~MainSideBar.html">MainSideBar</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/common_components.jsx~PureRenderCommponent.html">PureRenderCommponent</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/replay_controls/replay_panel.jsx~ReplayPanel.html">ReplayPanel</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/stores/replay_store.js~ReplayStore.html">ReplayStore</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/stores/seq_diag_store.js~SeqDiagStore.html">SeqDiagStore</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/seq_diagram/seq_diagram.jsx~SeqDiagram.html">SeqDiagram</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/seq_diagram/signal.jsx~Signal.html">Signal</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/actions/simulation_action.js~SimulationAction.html">SimulationAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/views/simulation_view.jsx~SimulationView.html">SimulationView</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/stores/store_factory.js~StoreFactory.html">StoreFactory</a></span></li>
<li data-ice="classDoc"><span><a href="class/jbd_vis/client/components/common_components.jsx~UploadFileForm.html">UploadFileForm</a></span></li>
</ul>
</div>





<div data-ice="variableWrap">
  <h2><a href="variable/">Variable</a></h2>
  <ul>
    
  <li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-AdminJobsStore">AdminJobsStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-AppStore">AppStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-AssignmentsStore">AssignmentsStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-EventEmitter">EventEmitter</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-JvmListStore">JvmListStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-SessionStore">SessionStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-SimulationStore">SimulationStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-actor">actor</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-adminMonitorView">adminMonitorView</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-adminQuestionView">adminQuestionView</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-assignmentView">assignmentView</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-contentWrapper">contentWrapper</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-controlSideBar">controlSideBar</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-frame">frame</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-instance">instance</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-instance">instance</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-instance">instance</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-instance">instance</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-instance">instance</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-instance">instance</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-instance">instance</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-jobStore">jobStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-jvmListDrowDown">jvmListDrowDown</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-jvmStore">jvmStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-jvmsView">jvmsView</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-lifeline">lifeline</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-mainSideBar">mainSideBar</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-replayPanel">replayPanel</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-replayStore">replayStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-seqDiagStore">seqDiagStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-seqDiagram">seqDiagram</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-signal">signal</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-simulationView">simulationView</a></span></li>
</ul>
</div>




</nav>

<div class="content" data-ice="content"><h1 data-ice="title">jbd_vis/client/stores/seq_diag_store.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">var assign = require(&apos;object-assign&apos;);

var EventEmitter = require(&apos;events&apos;).EventEmitter;
var postJson = require(&apos;../utils/ajax.js&apos;).postJson;

import ReplayStore from &apos;./replay_store&apos;;

const UPDATE_EVENT = &apos;UPDATE_EVENT&apos;;
const REPLAY_UPDATE_EVENT = &apos;REPLAY_UPDATE&apos;;

const START_X = 80;  //start position for actor rendering
const START_Y = 100;
const ACTOR_MARGIN = 20;
class SeqDiagStore extends EventEmitter{

  constructor(jvm_store){
    super();
    this.jvm_store = jvm_store;
   
    this._data = {status: &quot;init&quot;, jvm_name: jvm_store._id};
    this.update();
    this.x = START_X;
    this.y = START_Y;
    this.replay_store = new ReplayStore();
  }

  getData(){
    return this._data;
  }

  reconcile_actor(actor){
    console.log(&quot;reconcile actor&quot;, this);
    actor.rendering_data.position_x = this.x;
    actor.rendering_data.height = this.y;
    if(actor.rendering_data &amp;&amp; actor.rendering_data.head_box){
      this.x = this.x + actor.rendering_data.head_box.width + ACTOR_MARGIN;
      var threads_count = Object.keys(actor.threads).length;
      //console.log(&quot;reconcile each thread in this actor&quot;, threads_count);
      this.emitChange();
    }else{
      console.log(this, actor);
      throw &quot;reconsile actor error: the redering data is invalid&quot;;
    }
  }
  
  replayJumpTo(signal){
    if(this.curr_replay_signal){
      this.curr_replay_signal.is_replay_on = false;
      this.curr_replay_signal.emit(&quot;REPLAY_UPDATE&quot;);
    }
    signal.is_replay_on = true;
    this.curr_replay_signal = signal;
    signal.emit(&quot;REPLAY_UPDATE&quot;);
    this.replay_store.reload(signal.to_lifeline);//store for replay panel
    this.emitReplayEvent();
  }
  
  buildDataRelation(actors, signals, lifelines){
    var actor_map = {};
    var lifeline_map = {};
    for(var actor of actors){
      //console.log(&quot;build rel&quot;, actor);
      actor_map[actor._id] = actor;
      actor.threads = {};
    }
    for(var lifeline of lifelines){
      var actor_id = lifeline._id.split(&apos;:&apos;).slice(0,3).join(&apos;:&apos;);
      lifeline.actor = actor_map[actor_id];
      lifeline.actor.threads[lifeline.thread_id] = {center_x:0};
      var lifeline_short_id = lifeline._id.split(&apos;:&apos;).slice(3,5).join(&apos;:&apos;);
      //console.log(&quot;short id&quot;, lifeline_short_id);
      lifeline_map[lifeline_short_id] = lifeline;
    }
    for(let i in signals){
      signals[i] = assign(signals[i], EventEmitter.prototype); 
      var signal = signals[i];
      signal.index = i;
      signal.from_lifeline = lifeline_map[signal.from_id.split(&apos;:&apos;).slice(3,5).join(&apos;:&apos;)];
      signal.to_lifeline = lifeline_map[signal.thread_id + &quot;:&quot; + (signal.invocation_id + 1)]; //+1 for next method enter.
      //todo: improve me later:
      signal.y = this.y;
      var height = 35;
      if(signal.from_lifeline.actor == signal.to_lifeline.actor){
        height +=20; 
      }
      this.y += height + 6;
      var update_lifeline_y = (lifeline)=&gt;{
        if(!lifeline.y)
          lifeline.y = signal.y + 5;
        lifeline.height = signal.y - lifeline.y + height;
      };
      update_lifeline_y(signal.from_lifeline);
      update_lifeline_y(signal.to_lifeline);

    }
    
  }


  
  update(){
    console.log(&quot;reload seq diagram store&quot;, this);
    this.jvm_store.getSeqDiagram().then(
      (data) =&gt;{
        console.log(&quot;seq data loaded&quot;, this.jvm_store._id, data);
        this._data.status = &quot;ready&quot;, 
        this._data.data = data.data;
        this.buildDataRelation(data.data.actors, data.data.signals, data.data.lifelines);
        this.emitChange();
      }
    ).catch(
      (err)=&gt;{
        console.log(err);
        throw err;
      }
    );
  }
  emitChange() {
    this.emit(UPDATE_EVENT);
  }
   
  addUpdateEventListener(callback){
    this.on(UPDATE_EVENT, callback);
  }

  
  removeUpdateEventListener(callback){
    this.removeListener(UPDATE_EVENT, callback);
  }

  emitReplayEvent() {
    this.emit(REPLAY_UPDATE_EVENT);
  }
   
  addReplayEventListener(callback){
    this.on(REPLAY_UPDATE_EVENT, callback);
  }

  
  removeReplayEventListener(callback){
    this.removeListener(REPLAY_UPDATE_EVENT, callback);
  }
}

export default SeqDiagStore;
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.2.4)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
